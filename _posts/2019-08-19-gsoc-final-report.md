---
layout: post
title: "Final Report: GSoC 2019"
description: "A quick summary of the entire 3-month project."
---

## Contents

 - [Overview](##overview)
 - [Tasks and Challenges](##tasks)
    - [Map](##map)
    - [Rails](##rails)
    - [Combat](##combat)
    - [Economy](##economy)
    - [Quests](##quests)
 - [Future Prospects](##future)
 - [Pull Requests](##prs)
 - [Issues](##issues)
 - [Wiki](##wiki)
 - [Useful Links](##links)

## <a name="overview"></a>Overview

**Project:** Metal Renegades Multiplayer

**Organization:** The Terasology Foundation

Project [link](https://summerofcode.withgoogle.com/projects/##6267818473947136) on the GSoC website.

Terasology is an open source voxel based online multiplayer sandbox game. Metal Renegades is a new gameplay template for Terasology. It is set in a fantasy setting of a Wild West populated by robots and aims to give players an RPG style gameplay with different factions and quests. My project focused on adapting basic gameplay systems from other modules into this one and have a playable multiplayer in the end. The module also provides the necessary framework to build upon and implement more complex systems.

## <a name="tasks"></a> Tasks and Challenges

### <a name="map"></a>The Map

The unique settlements and terrain form the basis of this game mode. Most of my goals were successfully accomplished and the ones that had to be left have no impact on the gameplay.

![Surface](/assets/images/posts/gsoc/Surface.png)

#### Terrain
The terrain generated by the map is a simple desert with minor height variations (of three blocks) generated randomly. It also has some mountains and hills originally generated using _Perlin Noise_, which was deprecated in the course of this project. They now use _Simplex Noise_. It is calculated as `surfaceNoise.noise(position.x(), position.y()) * 3 + 10)`

**Challenges:** 
1. The surface temperature and humidity at a point define a biome. I was trying to manipulate these two parameters in a way that would give me the `PLAINS` biome occasionally on the map, but wasn't able to achieve satisfactory results. For now, the temperature and humidity values are constant, resulting in a desert throughout.
2. The lakes shown in the image below were also removed because of performance issues in the **Lakes** module.

![city](/assets/images/posts/gsoc/city.png)

#### Cities
The **DynamicCities** module was used to add them. One necessary change was that the DC module checked for grass when it chose locations to build a city. As our desert map doesn't have grass at all, this check had to be removed. A number of other changes were also made to the module to facilitate other features. All changes can be seen below in the PRs section.

![minimap](/assets/images/posts/gsoc/minimap.gif)

#### Minimap
An icon was added to the minimap marking cities that have been discovered. This makes finding cities that you've already found easier. The icons are clamped to the border of the map by the following code in `CentreOverlay`

```java
private Vector2i clamp(Vector2f point, Rect2f box) {
    float x;
    float y;
    Rect2f iconRegion = Rect2f.createFromMinAndSize(point, iconSize);
    if (box.contains(iconRegion)) {
        return new Vector2i(point.x, point.y);
    } else {
        if (iconRegion.maxX() >= box.maxX()) {
            x = (int) box.maxX() - iconSize.x;
        } else if (iconRegion.minX() <= box.minX()) {
            x = (int) box.minX();
        } else {
            x = point.x;
        }
        if (iconRegion.maxY() >= box.maxY()) {
            y = (int) box.maxY() - iconSize.y;
        } else if (iconRegion.minY() <= box.minY()) {
            y = (int) box.minY();
        } else {
            y = point.y;
        }
    }
    return new Vector2i(x, y);
}
```

### <a name="rails"></a> Rails

Rails was a critical part of Metal Renegades from the start, due to its industrial setting. Some new improvements were made to the module, but many more network issues came up and had to be left for later.

![rails](/assets/images/posts/gsoc/rails.png)

#### Connecting Cities
Before I started connecting cities with rails in MR, I first had to connect cities by roads in DC. Once that was completed, I only had to create a rasterizer in MR which would lay down custom blocks on the roads created. I also implemented a priority system for rails to solve the problem of which rail from the family should be laid down in case we have multiple options. The system checks if some rotation of a higher priority block is available. If not, it goes down to a lower priority. The following is the code to do that, in `RailBlockFamily`.

```java
private Block getClosestMatch(byte connections, Side topSide) {
    EnumSet<Side> sides = SideBitFlag.getSides(connections);
    // Indices represent priorities, 0 being the highest and 6 being the lowest
    String[] keys = new String[baseSideBitMap.size()];
    keys[0] = FOUR_CONNECTIONS_CROSS;
    keys[1] = THREE_CONNECTIONS_T;
    keys[2] = ONE_CONNECTIONS_SLOPE;
    keys[3] = TWO_CONNECTIONS_CORNER;
    keys[4] = TWO_CONNECTIONS_LINE;
    keys[5] = ONE_CONNECTION;
    keys[6] = NO_CONNECTIONS;
    for (String k : keys) {
        Block result = checkConnection(sides, k, topSide);
        if (result != null) {
            return result;
        }
    }
    return blocks.get((byte) 0); // default block, simple no connection block
}

private Block checkConnection(EnumSet<Side> sides, String connection, Side topSide) {
    // if building slopes, make sure it is in the direction of the top block
    if (connection.equals(ONE_CONNECTIONS_SLOPE)) {
        if (sides.contains(Side.TOP) && sides.contains(topSide.reverse())) {
            byte b = SideBitFlag.getSides(topSide.reverse(), Side.TOP);
            return blocks.get(b);
        } else {
            return null;
        }
    }
    Set<Byte> arrangements = new HashSet<>();
    for (Rotation rotation : Rotation.horizontalRotations()) {
        byte sideBits = 0;
        for (Side side : SideBitFlag.getSides(baseSideBitMap.get(connection))) {
            sideBits += SideBitFlag.getSide(rotation.rotate(side));
        }
        arrangements.add(sideBits);
    }
    for (byte b : arrangements) {
        if (sides.containsAll(SideBitFlag.getSides(b))) {
            return blocks.get(b);
        }
    }
    return null;
}
```

**Challenges:**
 1. There's a huge performance hit when a new city is found and the road is calculated, despite things being cached all the time and using custom block placement classes from DC. After the road is laid the game turns back to normal. This will need to be investigated more thoroughly later.
 2. The road is laid in _segments_ which are directed portions of the road. The `RailRasterizer` needs improvements to fix some issues at segment boundaries, like the ones shown in the image below.
 3. Information about surface height is not handled properly. This works for MR which has a largely flat world, but doesn't work for mountainous terrains and other modules, like **TutorialDynamicCities**. In those cases, roads but through mountains and clear everything on top, forming a chasm.

![finalLoco](/assets/images/posts/gsoc/finalLoco.png)

#### AdvancedRails
A new AdvancedRails module was created to extract some stable features from **AdditionalRails**. The locomotive cart was extracted.

#### Networking
This is where most of the problems with rails lie. I mentioned some of them in [this post](https://wabadump.postach.io/post/week-8-combat-and-economy). Apart from that, I couldn't reliably reproduce issue [##39](https://github.com/Terasology/Rails/issues/39) to find the cause. Multiple other bugs were found, like [##47](https://github.com/Terasology/Rails/issues/47). Most of these bugs had to be left to proceed with the project. These need to be worked on in the future.

### <a name="combat"></a> Combat and Hunting

#### Weapons
A Pistol and a Gatling Gun was added. These are implemented as bows only, with different fire rates. Bullet projectiles are just arrows that have a golden texture. Implementing weapons this way allowed me to have a prototype up and ready quickly. A more _gun specific_ implementation can be attempted in the future, with magazines and reloads. Pistols are given to all players at spawn along with 32 bullets. The gatling gun can be obtained with the `give gatling` command.

![killDeer](/assets/images/posts/gsoc/killDeer.gif)

#### Animals and Loot
Animals are implemented through the **WildAnimals** module. They have a default flee-on-attack behavior and drop meat when killed. I modified the `WildAnimalsSpawnSystem` to get more control in the MR module. Basic configuration options were exposed and the ability to set a custom function to decide where to spawn animals was added. This allowed me to tune the number of deer I wanted and the size of a group. I also used the custom function to have the deer spawn only outside the city. So as the cities grow, spawn points are shifted away.

```java
private boolean isValidSpawnPosition(Vector3i pos) {
    if (!settlementEntityManager.checkOutsideAllSettlements(new Vector2i(pos.x, pos.z))) {
        return false;
    }
    Vector3i below = new Vector3i(pos.x, pos.y - 1, pos.z);
    Block blockBelow = worldProvider.getBlock(below);
    if (!blockBelow.equals(sand)) {
        return false;
    }
    Block blockAtPosition = worldProvider.getBlock(pos);
    if (!blockAtPosition.isPenetrable()) {
        return false;
    }
    Vector3i above = new Vector3i(pos.x, pos.y + 1, pos.z);
    Block blockAbove = worldProvider.getBlock(above);
    if (!blockAbove.equals(air)) {
        return false;
    }
    return true;
}
```

I then use a `spawnSystem.setSpawnCondition(this::isValidSpawnPosition)` to pass this custom function to the actual `WildAnimalsSpawnSystem`.

![itemDrops](/assets/images/posts/gsoc/itemDrops.gif)

#### Player Drops
Just like looting animals, players may also loot other players. As shown in the GIF below, players drop all inventory items on death.

**Challenges:**
I modified the inventory management that **CombatSystem** did to add some items to the player's inventory on spawn. The problem here was that I was creating item entities in an authority system and then telling the CombatSystem module to pass them to the players. This resulted in all items being owned by the host. This also resulted in an interesting bug [##33](https://github.com/Terasology/MetalRenegades/issues/33). I had to fix this before I could add player drops because a client can only drop items it owns.

### <a name="economy"></a> Economy

![wallet](/assets/images/posts/gsoc/wallet.png)

#### Currency
Currency has been implemented like any other resource and a _wallet_ has been given to each player to store their cash. An early version of the wallet UI can be seen on the left in the screenshot below.

**Challenges:**
Although currency is a resource in itself, currency in a player's wallet is not modified through the events provided for resource manipulation in the **Economy** module, i.e. I'm not using the `ResourceDrawEvent` or `ResourceStoreEvent` to modify currency in the wallet. This works for simple applications for now but will need to be changed when we implement economies for our settlements. The city itself would have some _wealth_ and if all transactions happen through these events, we can easily build up interdependent economies.

![sell](/assets/images/posts/gsoc/sell.png)

#### Markets
Markets have dedicated citizens assigned. The player just has to interact with them and select whether they want to buy or sell. The screenshot below is the selling interface. There is a `MarketUISystem` which fetches all resources that the city has (in case of _buying_) or fetches all items from the player's inventory (in case of _selling_). All resources are converted into a `MarketItem`, which is a data class holding other information that needs to be shown in the UI, like the description and cost. When a transaction is confirmed, the resources in the city, items in the player's inventory and the money in the wallet are appropriately modified. The `buy()` method is given below as an example.

```java
private MarketItem buy(MarketItem item) {
    if (!walletSystem.isValidTransaction(-1 * item.cost)) {
        logger.warn("Insufficient funds");
        return item;
    } else {
        if (!createItemOrBlock(item.name)) {
            logger.warn("Failed to create entity");
            return item;
        }
        Iterable<EntityRef> storageBuildings = entityManager.getEntitiesWith(MultiInvStorageComponent.class, SettlementRefComponent.class);
        for (EntityRef bldg : storageBuildings) {
            if (!bldg.isActive() || !bldg.exists()) {
                continue;
            }
            MultiInvStorageComponent component = bldg.getComponent(MultiInvStorageComponent.class);
            playerResourceStore.send(new ResourceDrawEvent(item.name, 1, bldg));
            logger.info("\n\n playerStore: {} \n bldg: {} \n\n",
                    playerResourceStore.getComponent(InfiniteStorageComponent.class).inventory.get(item.name),
                    handler.availableResourceAmount(component, item.name));
            item.quantity--;
            break;
        }
        localPlayer.getCharacterEntity().send(new UpdateWalletEvent(-1 * item.cost));
    }
    return item;
}
```

**Challenges:**
1. The way that the items are collected doesn't treat block families right. All of them show up as `engine:blockItemBase`
2. The market UI doesn't come up in multiplayer. This has to do with the way events travel and which system processes those events.
3. Resources which "belong to the city" are not synced properly. After a transaction, their quantity is set to zero. This also includes chests in the blacksmith's building. Items that you put in those chests come up in the market, but once a transaction is done, the city treats it as having quantity zero.

![trade](/assets/images/posts/gsoc/trade.gif)

#### Trade
Trade works just like the marketplace, but this time we can directly manipulate inventories. Involving the economy module is not necessary. To trade with an NPC, players first have to select what they want from the left list and then select what they'll give from the right list. If the costs of both the items are _about equal_, then the NPC considers the trade and will accept with some predefined probability.

### <a name="quests"></a>Quests

![questEnd](/assets/images/posts/gsoc/questEnd.png)

Only a basic fetch quest was implemented, using the **Tasks** module. Every church in a settlement has a quest point, which gives the player a quest. The player needs to bring back 2 pieces of meat in exchange for a cash reward. Implementation is fairly straightforward and was done with **QuestExamples** as a reference.

**Challenges:**
1. The Tasks module works with _quest items_. When you reach a quest point, you get a quest item which activates the quest when it is used. I wanted to turn the quest point into a beacon when the return home task was initiated, so I had to know from which quest point my quest actually came from. 
2. Having multiple quest points with the same quest also meant that the beacon ID defined in the quest prefab was the same for all of them. So when a player completes the quest and starts another one, the return task on the second quest is already completed because the beacon with the _same ID_ has already been reached.
3. The minimap overlay that shows the beacon doesn't accurately pinpoint the location of the beacon.


## <a name="future"></a> Future Plans

#### Backlog:

 - Test and fix minimap overlays for multiplayer
 - Rails: Needs a networking overhaul. Also extract carts into AdvancedRails
 - Diversify the terrain with more biomes
 - Create a settlement-wide economy with proper resource exchanges and production
 - Add more quests and fix existing fetch quests
 - Better support guns in the CombatSystem module. Add support for different magazine sizes and reloading. Maybe even add hit indicators or health bars above other players
 - Optimize performance: Because a lot of the code comes from other modules, this will be a very major undertaking

#### Cool features to add:

 - Tumbleweed
 - Player stats and crafting
 - PvP duels
 - Larger rails and scheduled trains. Could be passenger or goods trains
 - Allow the players to ride on horseback
 - Organized raids on buildings/settlements
 - Add more weapons
 - Allow players to trade among themselves, not just NPCs

## <a name="prs"></a> Pull Requests

 - Metal Renegades: [##1](https://github.com/Terasology/MetalRenegades/pull/1), [##2](https://github.com/Terasology/MetalRenegades/pull/2), [##9](https://github.com/Terasology/MetalRenegades/pull/9), [##12](https://github.com/Terasology/MetalRenegades/pull/12), [##13](https://github.com/Terasology/MetalRenegades/pull/13), [##14](https://github.com/Terasology/MetalRenegades/pull/14), [##18](https://github.com/Terasology/MetalRenegades/pull/18), [##24](https://github.com/Terasology/MetalRenegades/pull/24), [##27](https://github.com/Terasology/MetalRenegades/pull/27), [##30](https://github.com/Terasology/MetalRenegades/pull/30), [##34](https://github.com/Terasology/MetalRenegades/pull/34), [##35](https://github.com/Terasology/MetalRenegades/pull/35)
 - Dynamic Cities: [##41](https://github.com/Terasology/DynamicCities/pull/41), [##42](https://github.com/Terasology/DynamicCities/pull/42), [##44](https://github.com/Terasology/DynamicCities/pull/44), [##46](https://github.com/Terasology/DynamicCities/pull/46), [##47](https://github.com/Terasology/DynamicCities/pull/47)
 - Combat System: [##39](https://github.com/Terasology/CombatSystem/pull/39), [##40](https://github.com/Terasology/CombatSystem/pull/40), [##42](https://github.com/Terasology/CombatSystem/pull/42)
 - Economy: [##10](https://github.com/Terasology/Economy/pull/10), [##11](https://github.com/Terasology/Economy/pull/11)
 - WildAnimals: [##29](https://github.com/Terasology/WildAnimals/pull/29), [##30](https://github.com/Terasology/WildAnimals/pull/30)
 - Tasks: [##13](https://github.com/Terasology/Tasks/pull/13)
 - Minimap: [##11](https://github.com/Terasology/Minimap/pull/11)
 - Rails: [##46](https://github.com/Terasology/Rails/pull/46)
 - AdditionalRails: [##31](https://github.com/Terasology/Rails/pull/46)
 - AdvancedRails: [##1](https://github.com/Terasology/AdvancedRails/pull/1)

## <a name="issues"></a> Issues Created

#### Open

 - MetalRenegades: [##23](https://github.com/Terasology/MetalRenegades/issues/23), [##32](https://github.com/Terasology/MetalRenegades/issues/32), [##38](https://github.com/Terasology/MetalRenegades/issues/38), [##39](https://github.com/Terasology/MetalRenegades/issues/39), [##40](https://github.com/Terasology/MetalRenegades/issues/40)
 - AdvancedRails: [##3](https://github.com/Terasology/AdvancedRails/issues/3)
 - Rails: [##47](https://github.com/Terasology/Rails/issues/47), [##48](https://github.com/Terasology/Rails/issues/48)
 - CombatSystem: [##41](https://github.com/Terasology/CombatSystem/issues/41)
 - DynamicCities: [##52](https://github.com/Terasology/DynamicCities/issues/52), [##53](https://github.com/Terasology/DynamicCities/issues/53)
 - Lakes: [##3](https://github.com/Terasology/Lakes/issues/3)

#### Closed

 - MetalRenegades: [##33](https://github.com/Terasology/MetalRenegades/issues/33)
 - AdvancedRails: [##2](https://github.com/Terasology/AdvancedRails/issues/2)

## <a name="wiki"></a> Wiki Pages Created

 - [Quick Start](https://github.com/Terasology/MetalRenegades/wiki/Quick-Start)

#### For Players

 - [World](https://github.com/Terasology/MetalRenegades/wiki/Players:-World)
 - [Quests](https://github.com/Terasology/MetalRenegades/wiki/Players:-Quests)
 - [Trade and Markets](https://github.com/Terasology/MetalRenegades/wiki/Players:-Trade-and-Markets)
 - [Combat](https://github.com/Terasology/MetalRenegades/wiki/Players:-Combat)

#### For Developers

 - [World Generation](https://github.com/Terasology/MetalRenegades/wiki/Developers:-World-Generation)
 - [Quests](https://github.com/Terasology/MetalRenegades/wiki/Developers:-Quests)
 - [Economic Systems](https://github.com/Terasology/MetalRenegades/wiki/Developers:-Economic-Systems)
 - [Combat Systems](https://github.com/Terasology/MetalRenegades/wiki/Developers:-Combat-Systems)

## <a name="links"></a> Useful Links
 - [Main Repo](https://github.com/Terasology/MetalRenegades/)
 - [Wiki](https://github.com/Terasology/MetalRenegades/wiki)
 - [Forum Post](https://forum.terasology.org/threads/gsoc-19-metal-renegades-multiplayer.2264/)
 - [Proposal](https://docs.google.com/document/d/1n4Xx8Drcg89QVs7ORMh-jkFbE-ofXoJuyQwNo1ioA9Y/edit?usp=sharing)

## Thank You!